import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
from sentinel5dl import search, download
import os

st.title("Mapa Interativo da Qualidade do Ar – Hortolândia")

# 1) Configurações
st.sidebar.header("Parâmetros de Consulta")
start_date = st.sidebar.date_input("Data início", value=pd.to_datetime("2025-09-01"))
end_date = st.sidebar.date_input("Data fim", value=pd.to_datetime("2025-09-05"))
product = st.sidebar.selectbox("Poluente", ["NO2", "CO", "O3"], index=0)
bbox = "-47.24 -22.88, -47.20 -22.88, -47.20 -22.82, -47.24 -22.82, -47.24 -22.88"

# 2) Busca e download (se ainda não existe)
key = f"{product}_{start_date}_{end_date}.nc"
if not os.path.exists(key):
    result = search(polygon=bbox, begin_ts=f"{start_date}T00:00:00Z",
                    end_ts=f"{end_date}T23:59:59Z",
                    product=f"L2__{product}____",
                    processing_level="L2",
                    processing_mode="Offline")
    if not result:
        st.error("Nenhum dado encontrado")
        st.stop()
    st.write("Downloads encontrados:", len(result))
    download(result, key)
    st.success("Download concluído")

# 3) Carregar dados simples (para mostrar ponto)
# Aqui simplificamos transformando o arquivo em csv: latitude, longitude, value
# Em um caso real, usar NetCDF / xarray para extrair pixel points
df = pd.read_csv("data/hortolandia_ar.csv")  # placeholder para sua fonte real

# 4) Visualização no mapa
center = [-22.86, -47.22]
m = folium.Map(location=center, zoom_start=12)

for _, row in df.iterrows():
    popup = f"Data: {row['data']}<br>{product}: {row[product.lower()]}"
    folium.CircleMarker(
        [row["latitude"], row["longitude"]],
        radius=8,
        popup=popup,
        color="red" if row[product.lower()] > df[product.lower()].mean() else "green",
        fill=True
    ).add_to(m)

st_folium(m, width=700, height=500)
